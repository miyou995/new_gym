{% load i18n %}
{% load widget_tweaks %}
{% csrf_token %}

<div class="container-fluid">
    <!-- Date Input and Button Above the Calendar -->
    <div class="row mb-3">
        <div class="col-md-12 d-flex justify-content-between">
            <div>
                <label class="d-flex align-items-center fs-6 fw-semibold mb-2">
                    <span class="card-label fw-bold fs-2 text-grey-800">DÃ©but Date</span>
                </label>
                <input type="date" name="debut_date" class="form-control" id="debut_date" />
            </div>
            <div class="align-self-end">
                <button
                    id="add-abonnement-btn"
                    type="button"
                    class="btn btn-primary btn-sm"
                    hx-post="{% url 'abonnement:add_abonnement_client' client_pk=client.pk %}" 
                    hx-trigger="click"
                >
                    <i class="ki-exit-up fs-2">Confirmer</i>
                </button>
            </div>
        </div>
    </div>

    <!-- Calendar Full Width -->
    <div class="row">
        <div class="col-md-12">
            <!-- Calendar will take up the full width -->
            <div id="calendar" style="width: 100%;"></div>
        </div>
    </div>
</div>


    <script>   
        console.log("calenderrrrrrrrrrrrrrr")
        var selectedEvents = [];
        var typeAbonnement = "{{ type_abonnement|escapejs }}"; // Ensure type_abonnement is safely escaped for JS
    
        function initCalendar(eventsData) {
        console.log("inticalender")

            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek', // Set the initial view to one week
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: '' // Disable other views to enforce the one-week display
                },
                slotMinTime: '06:00:00',
                slotDuration: '01:00:00',
                events: eventsData,
                selectable: true,
                eventClick: function(info) {
                    info.jsEvent.preventDefault();
    
                    var selectedEvent = {
                        event_pk: info.event.extendedProps.pk_event,
                        title: info.event.title,
                        startTime: info.event.start.toISOString(),
                        endTime: info.event.end.toISOString(),
                        url: info.event.url
                    };
                    var index = selectedEvents.findIndex(event => event.url === selectedEvent.url);
    
                    if (index === -1) {
                        selectedEvents.push(selectedEvent);
                        info.el.classList.add('selected-event'); // Add shadow to the selected event
                    } else {
                        selectedEvents.splice(index, 1);
                        info.el.classList.remove('selected-event'); // Remove shadow from the deselected event
                    }
                    updateSidebar(selectedEvents); // Update the sidebar with the selected events
                }
            });
            calendar.render();
        }
    
        function updateSidebar(selectedEvents) {
        console.log("updateside")

            var addAbonnementBtn = document.getElementById('add-abonnement-btn');
            if (selectedEvents.length > 0) {
                var eventPks = selectedEvents.map(event => event.event_pk); 
                var today = document.getElementById('debut_date').value; // Get the selected date

                addAbonnementBtn.setAttribute('hx-vals', JSON.stringify({
                    'event_pk': eventPks,
                    'type_abonnement': typeAbonnement ,
                    'today':today 
                }));
            } else {
                addAbonnementBtn.removeAttribute('hx-vals');
            }
        }

document.addEventListener('DOMContentLoaded', function() {
    console.log("date calender")

    initCalendar({{ events|safe }});

    var today = new Date();
        var formattedDate = today.toISOString().split('T')[0];
        document.getElementById('debut_date').value = formattedDate;
    //search without submit
    const form = document.getElementById('form_id');
        form.querySelectorAll('input, select, textarea').forEach(function(element) {
            element.addEventListener('change', function() {
                form.submit();
            });
        });
    //alert pour la selection de type abonnement
    form.addEventListener('add-abonnement-btn', function (event) {

            if (!typeAbonnement) {
                alert('veullez choisir an abonnement type.');
                event.preventDefault(); 
            }
        });
        var addAbonnementBtn = document.getElementById('add-abonnement-btn');
        addAbonnementBtn.addEventListener('click', function(event) {
            if (!typeAbonnement || typeAbonnement === "None") {
                // Show custom styled alert using SweetAlert
                Swal.fire({
                    icon: 'warning',
                    title: 'Error',
                    text: 'veullez choisir an abonnement type.',
                    confirmButtonText: 'OK'
                });
                event.preventDefault();  // Prevent form submission
            } else if (selectedEvents.length === 0) {
                // Ensure that at least one event is selected
                Swal.fire({
                    icon: 'warning',
                    title: 'Error',
                    text: 'veullez choisir un creneau ou des creneaux  .',
                    confirmButtonText: 'OK'
                });
                event.preventDefault();  // Prevent form submission
            }
        });
        
    });
    


</script>